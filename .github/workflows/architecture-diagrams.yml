name: Architecture Diagrams Render

on:
  pull_request:
    paths:
      - 'docs/architecture/composable-ai-advisors-architecture.puml'
      - 'docs/architecture/composable-ai-advisors-architecture.dot'
      - 'docs/architecture/composable-ai-advisors-architecture.md'
  push:
    branches:
      - fix/**
    paths:
      - 'docs/architecture/composable-ai-advisors-architecture.puml'
      - 'docs/architecture/composable-ai-advisors-architecture.dot'
      - 'docs/architecture/composable-ai-advisors-architecture.md'
  workflow_dispatch:

jobs:
  render:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz plantuml

      - name: Determine changed files
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="origin/${{ github.base_ref }}"
            git fetch origin "${{ github.base_ref }}" --depth=1
            CHANGED="$(git diff --name-only "${BASE}"...HEAD)"
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            CHANGED="$(git diff --name-only "${BEFORE}" "${AFTER}")"
          fi
          echo "${CHANGED}" | sed '/^\s*$/d' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt || true
          # Filter by type
          awk '/\.puml$/' changed_files.txt > changed_puml.txt || true
          awk '/\.dot$/' changed_files.txt > changed_dot.txt || true
          echo "puml_count=$(wc -l < changed_puml.txt | tr -d " ")" >> $GITHUB_OUTPUT
          echo "dot_count=$(wc -l < changed_dot.txt | tr -d " ")" >> $GITHUB_OUTPUT
          # If the architecture markdown changed, force-include its sources
          if grep -qx 'docs/architecture/composable-ai-advisors-architecture.md' changed_files.txt; then
            echo "docs/architecture/composable-ai-advisors-architecture.puml" >> changed_puml.txt
            echo "docs/architecture/composable-ai-advisors-architecture.dot" >> changed_dot.txt
          fi

      - name: Validate PlantUML syntax (changed .puml)
        run: |
          if [ -s changed_puml.txt ]; then
            xargs -a changed_puml.txt plantuml -checkonly
          else
            echo "No changed .puml files."
          fi

      - name: Validate DOT syntax (changed .dot)
        run: |
          if [ -s changed_dot.txt ]; then
            while IFS= read -r f; do
              dot -Tsvg "$f" -o /dev/null
            done < changed_dot.txt
          else
            echo "No changed .dot files."
          fi

      - name: Render PlantUML -> SVG (changed .puml)
        run: |
          if [ -s changed_puml.txt ]; then
            xargs -a changed_puml.txt plantuml -tsvg
          else
            echo "No changed .puml to render."
          fi

      - name: Render DOT -> SVG (changed .dot)
        run: |
          if [ -s changed_dot.txt ]; then
            while IFS= read -r f; do
              dot -Tsvg "$f" -o "${f}.svg"
            done < changed_dot.txt
          else
            echo "No changed .dot to render."
          fi

      - name: Commit rendered SVGs
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): render architecture diagrams (PlantUML/DOT) to SVG"
          file_pattern: |
            docs/architecture/*.svg

