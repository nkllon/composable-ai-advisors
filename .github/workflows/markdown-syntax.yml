name: Markdown Syntax Check

on:
  pull_request:
    paths:
      - "**/*.md"
  push:
    branches:
      - fix/**
      - chore/**
      - docs/**
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed Markdown files
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="origin/${{ github.base_ref }}"
            git fetch origin "${{ github.base_ref }}" --depth=1
            CHANGED="$(git diff --name-only "${BASE}"...HEAD -- '**/*.md')"
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            CHANGED="$(git diff --name-only "${BEFORE}" "${AFTER}" -- '**/*.md')"
          fi
          echo "${CHANGED}" | sed '/^\s*$/d' > changed_md.txt
          echo "Changed Markdown files:"
          cat changed_md.txt || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli2
        run: npm i -g markdownlint-cli2

      - name: Lint with markdownlint-cli2
        run: |
          if [ -s changed_md.txt ]; then
            while IFS= read -r f; do
              markdownlint-cli2 "$f" "#node_modules"
            done < changed_md.txt
          else
            echo "No changed Markdown files."
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyMarkdown
        run: pipx install pymarkdownlnt

      - name: Lint with PyMarkdown
        run: |
          if [ -s changed_md.txt ]; then
            pymarkdown scan --strict-config $(tr '\n' ' ' < changed_md.txt)
          else
            echo "No changed Markdown files."
          fi

