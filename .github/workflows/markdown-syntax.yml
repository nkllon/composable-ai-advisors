name: Markdown Syntax Check

on:
  pull_request:
    paths:
      - "**/*.md"
  push:
    branches:
      - fix/**
      - chore/**
      - docs/**
    paths:
      - "**/*.md"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed Markdown files
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="origin/${{ github.base_ref }}"
            git fetch origin "${{ github.base_ref }}" --depth=1
            CHANGED="$(git diff --name-only "${BASE}"...HEAD -- '**/*.md')"
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            CHANGED="$(git diff --name-only "${BEFORE}" "${AFTER}" -- '**/*.md')"
          fi
          echo "${CHANGED}" | sed '/^\s*$/d' > changed_md.txt
          # Exclude command templates and internal cursor command files
          if [ -s changed_md.txt ]; then
            grep -v -E '^\\.cursor/commands/' changed_md.txt > changed_md.filtered || true
            mv changed_md.filtered changed_md.txt
          fi
          echo "Changed Markdown files:"
          cat changed_md.txt || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm i -g markdownlint-cli

      - name: Lint with markdownlint
        run: |
          if [ -s changed_md.txt ]; then
            while IFS= read -r f; do
              case "$f" in
                .cursor/commands/*) continue ;;
              esac
              markdownlint -c .markdownlint.yml "$f"
            done < changed_md.txt
          else
            echo "No changed Markdown files."
          fi

      - name: Setup Python
        if: ${{ false }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyMarkdown
        if: ${{ false }}
        run: pipx install pymarkdownlnt

      - name: Lint with PyMarkdown
        if: ${{ false }}
        run: echo "PyMarkdown temporarily disabled for this repository."

